<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect x='15' y='8' width='50' height='65' rx='3' fill='%23f5f5dc' stroke='%23555' stroke-width='3'/><line x1='25' y1='25' x2='55' y2='25' stroke='%23aaa' stroke-width='2'/><line x1='25' y1='35' x2='55' y2='35' stroke='%23aaa' stroke-width='2'/><line x1='25' y1='45' x2='45' y2='45' stroke='%23aaa' stroke-width='2'/><rect x='58' y='50' width='8' height='38' rx='2' transform='rotate(-30 62 69)' fill='%23f4c430' stroke='%23555' stroke-width='2'/><polygon points='49,84 53,74 57,78' fill='%23555'/></svg>">
<title>Notepad</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { display: flex; flex-direction: column; height: 100vh; font-family: system-ui; }
  #toolbar {
    display: flex; gap: 4px; padding: 6px 8px;
    background: #f0f0f0; border-bottom: 1px solid #ccc;
    align-items: center; flex-wrap: wrap;
  }
  #toolbar button {
    padding: 4px 12px; border: 1px solid #aaa; background: #fff;
    border-radius: 3px; cursor: pointer; font-size: 13px; color: #000;
  }
  #toolbar button:hover { background: #e8e8e8; }
  #toolbar button.active { background: #ddeeff; border-color: #88b; }
  .separator { width: 1px; height: 20px; background: #ccc; margin: 0 4px; }
  #filename { margin-left: 12px; color: #555; font-size: 13px; }
  #modified { color: #c00; font-size: 13px; margin-left: 4px; }
  #wordcount { margin-left: auto; color: #333; font-size: 13px; font-weight: 600; }
  #timer { cursor: pointer; color: #333; font-size: 13px; font-weight: 600; font-family: Consolas, 'Courier New', monospace; margin-left: 8px; user-select: none; }
  #timer.running { color: #4a4; }
  #brand-bar {
    display: none; padding: 12px 16px; align-items: center; gap: 12px;
    border-bottom: 1px solid #ccc; background: #fafafa;
  }
  #brand-bar.visible { display: flex; }
  #brand-logo {
    max-height: 48px; max-width: 200px; object-fit: contain; cursor: pointer;
  }
  #brand-logo:hover { opacity: 0.8; }
  #brand-placeholder {
    width: 48px; height: 48px; border: 2px dashed #aaa; border-radius: 6px;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; color: #999; font-size: 11px; text-align: center;
  }
  #brand-placeholder:hover { border-color: #666; color: #666; }
  #brand-text {
    font-size: 16px; font-weight: 600; color: #333;
    border: none; background: transparent; outline: none;
    font-family: system-ui; min-width: 120px;
  }
  #brand-text::placeholder { color: #aaa; }
  #content-area { display: flex; flex-direction: column; flex: 1; min-height: 0; position: relative; }
  #editor {
    flex: 1; padding: 12px; font-family: Consolas, 'Courier New', monospace;
    font-size: 14px; border: none; outline: none; resize: none;
    white-space: pre-wrap; word-wrap: break-word; overflow: auto; tab-size: 4;
    background: #fff; color: #000;
  }

  /* Read mode */
  #reader {
    display: none; flex: 1; padding: 20px 32px; overflow: auto;
    font-family: system-ui; font-size: 15px; line-height: 1.6;
    background: #fff; color: #222;
  }
  #reader.visible { display: block; }
  #reader .date-header {
    font-size: 18px; font-weight: 700; color: #444;
    border-bottom: 2px solid #e0e0e0; padding: 16px 0 6px;
    margin: 24px 0 12px;
  }
  #reader .date-header:first-child { margin-top: 0; }
  #reader .entry {
    display: flex; gap: 12px; padding: 8px 0;
    border-bottom: 1px solid #f0f0f0;
  }
  #reader .entry-time {
    font-size: 12px; color: #888; font-family: Consolas, 'Courier New', monospace;
    white-space: nowrap; min-width: 70px; padding-top: 2px;
  }
  #reader .entry-machine {
    font-size: 10px; background: #e8e8e8; color: #666;
    padding: 1px 6px; border-radius: 3px; font-family: Consolas, monospace;
    vertical-align: middle;
  }
  #reader .entry-body { flex: 1; word-wrap: break-word; }
  #reader .entry-body a { color: #2266cc; }
  #reader .tag {
    display: inline-block; font-size: 12px; padding: 1px 8px;
    border-radius: 10px; margin: 0 2px; cursor: pointer;
    background: #e3f0ff; color: #336; font-weight: 500;
  }
  #reader .tag:hover { background: #c8e0ff; }
  #reader .plain-line { padding: 4px 0; }
  #reader .plain-line:empty { height: 8px; }
  #reader .bold { font-weight: 700; }
  #reader .italic { font-style: italic; }
  #reader .strikethrough { text-decoration: line-through; color: #888; }
  #reader .inline-code {
    font-family: Consolas, 'Courier New', monospace; font-size: 13px;
    background: #f0f0f0; padding: 1px 5px; border-radius: 3px;
  }
  #reader blockquote {
    border-left: 3px solid #ccc; padding: 4px 12px; margin: 4px 0;
    color: #555; font-style: italic;
  }
  #reader .heading { font-weight: 700; margin: 16px 0 8px; }
  #reader .heading.h1 { font-size: 1.6em; }
  #reader .heading.h2 { font-size: 1.35em; }
  #reader .heading.h3 { font-size: 1.15em; }
  #reader .list-item { padding: 2px 0 2px 20px; position: relative; }
  #reader .list-item::before { content: '\2022'; position: absolute; left: 6px; color: #888; }
  #reader hr { border: none; border-top: 1px solid #ddd; margin: 12px 0; }

  /* Help panel */
  #help-panel {
    display: none; position: absolute; top: 36px; right: 80px;
    background: #fff; border: 1px solid #ccc; border-radius: 6px;
    padding: 14px 18px; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    min-width: 300px; max-height: 70vh; overflow: auto;
    font-size: 13px; line-height: 1.7;
  }
  #help-panel.visible { display: block; }
  #help-panel h3 { font-size: 14px; margin: 10px 0 4px; }
  #help-panel h3:first-child { margin-top: 0; }
  #help-panel code { background: #f0f0f0; padding: 1px 5px; border-radius: 3px; font-family: Consolas, monospace; font-size: 12px; }
  #help-panel table { width: 100%; border-collapse: collapse; margin: 4px 0 8px; }
  #help-panel td { padding: 2px 8px 2px 0; vertical-align: top; }
  #help-panel td:first-child { white-space: nowrap; }
  #help-panel a { color: #2266cc; }
  #reader .search-bar {
    display: flex; gap: 8px; padding: 8px 0 16px; align-items: center;
  }
  #reader .search-bar input {
    flex: 1; padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px;
    font-size: 14px; font-family: system-ui; outline: none;
  }
  #reader .search-bar input:focus { border-color: #88b; }
  #reader .search-bar .clear-btn {
    padding: 6px 12px; border: 1px solid #aaa; background: #f5f5f5;
    border-radius: 4px; cursor: pointer; font-size: 13px;
  }
  #reader .active-filter {
    display: inline-flex; align-items: center; gap: 4px;
    font-size: 13px; background: #e3f0ff; color: #336;
    padding: 4px 10px; border-radius: 12px; margin-bottom: 12px;
  }
  #reader .active-filter .remove-filter {
    cursor: pointer; font-weight: bold; margin-left: 4px;
    color: #666;
  }
  #reader .active-filter .remove-filter:hover { color: #c00; }

  .color-input-wrap { position: relative; display: inline-block; }
  .color-input-wrap input[type="color"] {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    opacity: 0; cursor: pointer;
  }

  /* Settings panel */
  #settings-panel {
    display: none; position: absolute; top: 36px; right: 8px;
    background: #fff; border: 1px solid #ccc; border-radius: 6px;
    padding: 12px 16px; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    min-width: 220px;
  }
  #settings-panel.visible { display: block; }
  #settings-panel label {
    display: flex; align-items: center; gap: 8px;
    font-size: 13px; color: #333; margin-bottom: 8px; cursor: pointer;
  }
  #settings-panel .setting-row {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 8px;
  }
  #settings-panel .setting-label { font-size: 13px; color: #333; }
  #settings-panel input[type="color"] { width: 32px; height: 24px; border: 1px solid #aaa; border-radius: 3px; cursor: pointer; }
  #settings-panel input[type="range"] { width: 100px; cursor: pointer; }
  #settings-panel .font-size-val { font-size: 13px; min-width: 32px; text-align: center; }
  #settings-panel select { font-size: 12px; padding: 2px 4px; border: 1px solid #aaa; border-radius: 3px; background: #fff; color: #000; cursor: pointer; }
  #settings-panel button {
    padding: 3px 10px; border: 1px solid #aaa; background: #f5f5f5;
    border-radius: 3px; cursor: pointer; font-size: 12px; color: #333;
  }
  #settings-panel button:hover { background: #e0e0e0; }

  /* Dark mode */
  body.dark { background: #1e1e1e; }
  body.dark #toolbar { background: #2d2d2d; border-bottom-color: #444; }
  body.dark #toolbar button { background: #3c3c3c; border-color: #555; color: #ddd; }
  body.dark #toolbar button:hover { background: #505050; }
  body.dark #toolbar button.active { background: #2a3a4a; border-color: #5588aa; }
  body.dark .separator { background: #555; }
  body.dark #filename { color: #aaa; }
  body.dark #wordcount { color: #bbb; }
  body.dark #timer { color: #bbb; }
  body.dark #timer.running { color: #6c6; }
  body.dark #modified { color: #f66; }
  body.dark #brand-bar { background: #252525; border-bottom-color: #444; }
  body.dark #brand-text { color: #ddd; }
  body.dark #brand-text::placeholder { color: #666; }
  body.dark #brand-placeholder { border-color: #555; color: #777; }
  body.dark #editor { background: #1e1e1e; color: #d4d4d4; }
  body.dark #reader { background: #1e1e1e; color: #d4d4d4; }
  body.dark #reader .date-header { color: #ccc; border-bottom-color: #444; }
  body.dark #reader .entry { border-bottom-color: #333; }
  body.dark #reader .entry-time { color: #777; }
  body.dark #reader .entry-machine { background: #3c3c3c; color: #aaa; }
  body.dark #reader .tag { background: #2a3a4a; color: #8cb4e0; }
  body.dark #reader .tag:hover { background: #344a5a; }
  body.dark #reader .entry-body a { color: #6cacee; }
  body.dark #reader .inline-code { background: #333; color: #d4d4d4; }
  body.dark #reader .strikethrough { color: #666; }
  body.dark #reader blockquote { border-left-color: #555; color: #999; }
  body.dark #reader hr { border-top-color: #444; }
  body.dark #reader .list-item::before { color: #666; }
  body.dark #help-panel { background: #2d2d2d; border-color: #444; color: #ddd; }
  body.dark #help-panel code { background: #3c3c3c; color: #ddd; }
  body.dark #help-panel a { color: #6cacee; }
  body.dark #reader .search-bar input { background: #2d2d2d; border-color: #555; color: #ddd; }
  body.dark #reader .search-bar .clear-btn { background: #3c3c3c; border-color: #555; color: #ddd; }
  body.dark #reader .active-filter { background: #2a3a4a; color: #8cb4e0; }
  body.dark #settings-panel { background: #2d2d2d; border-color: #444; color: #ddd; }
  body.dark #settings-panel .setting-label { color: #ddd; }
  body.dark #settings-panel label { color: #ddd; }
  body.dark #settings-panel button { background: #3c3c3c; border-color: #555; color: #ddd; }
  body.dark #settings-panel button:hover { background: #505050; }
  body.dark #settings-panel select { background: #3c3c3c; border-color: #555; color: #ddd; }

  @media print {
    #toolbar, #settings-panel { display: none !important; }
    #brand-bar.visible { display: flex !important; }
    #editor, #reader { overflow: visible; }
    #reader .search-bar { display: none !important; }
    #reader .active-filter { display: none !important; }
  }
</style>
</head>
<body>
<div id="toolbar">
  <button onclick="newFile()">New</button>
  <button onclick="openFile()">Open</button>
  <button onclick="saveFile()">Save</button>
  <button onclick="saveFileAs()">Save As</button>
  <div class="separator"></div>
  <button onclick="toggleReadMode()" id="readBtn">Read</button>
  <div class="separator"></div>
  <button onclick="toggleTheme()" id="themeBtn">Dark</button>
  <button onclick="toggleSettings()">Settings</button>
  <button onclick="copyToClipboard()">Copy</button>
  <button onclick="emailDraft()">Email</button>
  <button onclick="exportToWord()">Word</button>
  <button onclick="toggleHelp()">Help</button>
  <span id="filename">untitled</span>
  <span id="modified"></span>
  <span id="wordcount"></span>
  <span id="timer" onclick="toggleTimer()" title="Click to start/stop, double-click to reset">0:00</span>
</div>
<div id="settings-panel">
  <label>
    <input type="checkbox" id="showBrand" onchange="toggleBrand()">
    Show letterhead
  </label>
  <div class="setting-row">
    <span class="setting-label">Logo</span>
    <span>
      <button onclick="pickLogo()">Choose</button>
      <button onclick="removeLogo()">Remove</button>
    </span>
  </div>
  <div class="setting-row">
    <span class="setting-label">Font</span>
    <select id="fontFamily" onchange="setFontFamily(this.value)">
      <option value="">Default</option>
      <option value="Segoe UI">Segoe UI</option>
      <option value="Arial">Arial</option>
      <option value="Verdana">Verdana</option>
      <option value="Georgia">Georgia</option>
      <option value="Times New Roman">Times New Roman</option>
      <option value="Consolas">Consolas</option>
    </select>
  </div>
  <div class="setting-row">
    <span class="setting-label">Font size</span>
    <span style="display:flex;align-items:center;gap:4px">
      <input type="range" id="fontSize" min="10" max="32" value="14" oninput="setFontSize(this.value)">
      <span class="font-size-val" id="fontSizeVal">14px</span>
    </span>
  </div>
  <div class="setting-row">
    <span class="setting-label">Line spacing</span>
    <span style="display:flex;align-items:center;gap:4px">
      <input type="range" id="lineSpacing" min="1.2" max="2.4" step="0.1" value="1.6" oninput="setLineSpacing(this.value)">
      <span class="font-size-val" id="lineSpacingVal">1.6</span>
    </span>
  </div>
  <div class="setting-row">
    <span class="setting-label">Editor background</span>
    <input type="color" id="bgColor" value="#1e1e1e" onchange="setBgColor(this.value)">
  </div>
  <div class="setting-row">
    <span class="setting-label">Text color</span>
    <input type="color" id="fgColor" value="#d4d4d4" onchange="setFgColor(this.value)">
  </div>
  <div class="setting-row">
    <span class="setting-label">Background image</span>
    <span>
      <button onclick="pickBgImage()">Choose</button>
      <button onclick="removeBgImage()">Remove</button>
    </span>
  </div>
  <div class="setting-row">
    <button onclick="resetSettings()">Reset all settings</button>
  </div>
</div>
<div id="help-panel">
  <h3>Keyboard Shortcuts</h3>
  <table>
    <tr><td><code>Ctrl+S</code></td><td>Save</td></tr>
    <tr><td><code>Ctrl+O</code></td><td>Open</td></tr>
    <tr><td><code>Ctrl+N</code></td><td>New</td></tr>
    <tr><td><code>Ctrl+R</code></td><td>Toggle read mode</td></tr>
    <tr><td><code>Tab</code></td><td>Insert tab</td></tr>
    <tr><td><code>Email</code></td><td>Open Gmail compose with content</td></tr>
  </table>
  <h3>Formatting (visible in Read mode)</h3>
  <table>
    <tr><td><code>## Heading</code></td><td>Heading (# h1, ## h2, ### h3)</td></tr>
    <tr><td><code>**bold**</code></td><td><strong>bold</strong></td></tr>
    <tr><td><code>*italic*</code></td><td><em>italic</em></td></tr>
    <tr><td><code>~~strike~~</code></td><td><s>strikethrough</s></td></tr>
    <tr><td><code>`code`</code></td><td>Inline code</td></tr>
    <tr><td><code>> quote</code></td><td>Blockquote</td></tr>
    <tr><td><code>- item</code></td><td>Bullet list item</td></tr>
    <tr><td><code>---</code></td><td>Horizontal rule</td></tr>
    <tr><td><code>#tag</code></td><td>Clickable tag (filters in read mode)</td></tr>
    <tr><td><code>https://...</code></td><td>Auto-linked URL</td></tr>
  </table>
  <h3>Journal Format</h3>
  <table>
    <tr><td><code>=== Date ===</code></td><td>Date/section header</td></tr>
    <tr><td><code>[12:30:45] text</code></td><td>Timestamped entry</td></tr>
    <tr><td><code>[12:30:45 @PC] text</code></td><td>Entry with machine name</td></tr>
  </table>
  <p style="margin-top:10px"><a href="https://github.com/spinchange/notepad" target="_blank" rel="noopener">README &amp; source on GitHub</a></p>
</div>
<div id="brand-bar">
  <div id="brand-placeholder" onclick="pickLogo()">Add<br>logo</div>
  <img id="brand-logo" style="display:none" onclick="pickLogo()">
  <input type="text" id="brand-text" placeholder="Your name or company">
</div>
<div id="content-area">
  <textarea id="editor" spellcheck="false"></textarea>
  <div id="reader">
    <div class="search-bar" id="search-bar" style="display:none">
      <input type="text" id="searchInput" placeholder="Search..." oninput="renderReadMode()">
      <button class="clear-btn" id="clearBtn" onclick="clearFilters()" style="display:none">Clear</button>
    </div>
    <div id="activeFilterEl"></div>
    <div id="reader-content"></div>
  </div>
</div>
<input type="file" id="logoInput" accept="image/*" style="display:none">
<input type="file" id="bgInput" accept="image/*" style="display:none">
<script>
  let fileHandle = null;
  let savedContent = '';
  let inReadMode = false;
  let activeTagFilter = '';
  const editor = document.getElementById('editor');
  const reader = document.getElementById('reader');
  const filenameEl = document.getElementById('filename');
  const modifiedEl = document.getElementById('modified');
  const wordcountEl = document.getElementById('wordcount');
  const themeBtn = document.getElementById('themeBtn');
  const readBtn = document.getElementById('readBtn');
  const settingsPanel = document.getElementById('settings-panel');
  const brandBar = document.getElementById('brand-bar');
  const brandLogo = document.getElementById('brand-logo');
  const brandPlaceholder = document.getElementById('brand-placeholder');
  const brandText = document.getElementById('brand-text');
  const showBrandCheck = document.getElementById('showBrand');
  const bgColorInput = document.getElementById('bgColor');
  const fgColorInput = document.getElementById('fgColor');
  const logoInput = document.getElementById('logoInput');
  const bgInput = document.getElementById('bgInput');
  const fontSizeInput = document.getElementById('fontSize');
  const fontSizeVal = document.getElementById('fontSizeVal');
  const fontFamilyInput = document.getElementById('fontFamily');
  const lineSpacingInput = document.getElementById('lineSpacing');
  const lineSpacingVal = document.getElementById('lineSpacingVal');

  // --- Theme ---
  function toggleTheme() {
    const dark = document.body.classList.toggle('dark');
    themeBtn.textContent = dark ? 'Light' : 'Dark';
    localStorage.setItem('notepad-theme', dark ? 'dark' : 'light');
  }

  // --- Settings panel ---
  function toggleSettings() {
    settingsPanel.classList.toggle('visible');
  }
  document.addEventListener('click', (e) => {
    if (!settingsPanel.contains(e.target) && e.target.textContent !== 'Settings') {
      settingsPanel.classList.remove('visible');
    }
  });

  // --- Help panel ---
  const helpPanel = document.getElementById('help-panel');
  function toggleHelp() {
    helpPanel.classList.toggle('visible');
    settingsPanel.classList.remove('visible');
  }
  document.addEventListener('click', (e) => {
    if (!helpPanel.contains(e.target) && e.target.textContent !== 'Help') {
      helpPanel.classList.remove('visible');
    }
  });

  // --- Brand / Letterhead ---
  function toggleBrand() {
    const show = showBrandCheck.checked;
    brandBar.classList.toggle('visible', show);
    localStorage.setItem('notepad-showBrand', show);
  }

  // --- Logo ---
  function pickLogo() { logoInput.click(); }
  logoInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      setLogo(reader.result);
      localStorage.setItem('notepad-logo', reader.result);
    };
    reader.readAsDataURL(file);
    logoInput.value = '';
  });
  function setLogo(dataUrl) {
    brandLogo.src = dataUrl;
    brandLogo.style.display = 'block';
    brandPlaceholder.style.display = 'none';
  }
  function removeLogo() {
    brandLogo.src = '';
    brandLogo.style.display = 'none';
    brandPlaceholder.style.display = 'flex';
    localStorage.removeItem('notepad-logo');
  }

  // --- Brand text ---
  brandText.addEventListener('input', () => {
    localStorage.setItem('notepad-brandText', brandText.value);
  });

  // --- Font family ---
  function setFontFamily(family) {
    editor.style.fontFamily = family || '';
    reader.style.fontFamily = family || '';
    fontFamilyInput.value = family;
    localStorage.setItem('notepad-fontFamily', family);
  }

  // --- Line spacing ---
  function setLineSpacing(spacing) {
    editor.style.lineHeight = spacing;
    reader.style.lineHeight = spacing;
    lineSpacingInput.value = spacing;
    lineSpacingVal.textContent = parseFloat(spacing).toFixed(1);
    localStorage.setItem('notepad-lineSpacing', spacing);
  }

  // --- Font size ---
  function setFontSize(size) {
    editor.style.fontSize = size + 'px';
    reader.style.fontSize = size + 'px';
    fontSizeInput.value = size;
    fontSizeVal.textContent = size + 'px';
    localStorage.setItem('notepad-fontSize', size);
  }

  // --- Editor colors ---
  function setBgColor(color) {
    editor.style.background = color;
    localStorage.setItem('notepad-bgColor', color);
  }
  function setFgColor(color) {
    editor.style.color = color;
    localStorage.setItem('notepad-fgColor', color);
  }

  // --- Background image ---
  function pickBgImage() { bgInput.click(); }
  bgInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const r = new FileReader();
    r.onload = () => {
      setBgImage(r.result);
      localStorage.setItem('notepad-bgImage', r.result);
    };
    r.readAsDataURL(file);
    bgInput.value = '';
  });
  function setBgImage(dataUrl) {
    editor.style.backgroundImage = `url(${dataUrl})`;
    editor.style.backgroundSize = 'cover';
    editor.style.backgroundPosition = 'center';
    editor.style.backgroundRepeat = 'no-repeat';
  }
  function removeBgImage() {
    editor.style.backgroundImage = '';
    localStorage.removeItem('notepad-bgImage');
  }

  // --- Reset ---
  function resetSettings() {
    if (!confirm('Reset all settings to defaults?')) return;
    ['notepad-theme','notepad-showBrand','notepad-logo','notepad-brandText',
     'notepad-fontSize','notepad-fontFamily','notepad-lineSpacing',
     'notepad-bgColor','notepad-fgColor','notepad-bgImage'].forEach(k => localStorage.removeItem(k));
    location.reload();
  }

  // --- Restore settings ---
  function restoreSettings() {
    if (localStorage.getItem('notepad-theme') === 'dark') {
      document.body.classList.add('dark');
      themeBtn.textContent = 'Light';
    }
    if (localStorage.getItem('notepad-showBrand') === 'true') {
      showBrandCheck.checked = true;
      brandBar.classList.add('visible');
    }
    const logo = localStorage.getItem('notepad-logo');
    if (logo) setLogo(logo);
    const bt = localStorage.getItem('notepad-brandText');
    if (bt) brandText.value = bt;
    const ff = localStorage.getItem('notepad-fontFamily');
    if (ff) setFontFamily(ff);
    const fs = localStorage.getItem('notepad-fontSize');
    if (fs) setFontSize(fs);
    const ls = localStorage.getItem('notepad-lineSpacing');
    if (ls) setLineSpacing(ls); else setLineSpacing(1.6);
    const bg = localStorage.getItem('notepad-bgColor');
    if (bg) { editor.style.background = bg; bgColorInput.value = bg; }
    const fg = localStorage.getItem('notepad-fgColor');
    if (fg) { editor.style.color = fg; fgColorInput.value = fg; }
    const bgImg = localStorage.getItem('notepad-bgImage');
    if (bgImg) setBgImage(bgImg);
  }
  restoreSettings();

  // --- Read mode ---
  const searchInput = document.getElementById('searchInput');
  const searchBar = document.getElementById('search-bar');
  const clearBtn = document.getElementById('clearBtn');
  const activeFilterEl = document.getElementById('activeFilterEl');
  const readerContent = document.getElementById('reader-content');

  function toggleReadMode() {
    inReadMode = !inReadMode;
    editor.style.display = inReadMode ? 'none' : '';
    reader.classList.toggle('visible', inReadMode);
    readBtn.textContent = inReadMode ? 'Edit' : 'Read';
    readBtn.classList.toggle('active', inReadMode);
    if (inReadMode) {
      searchBar.style.display = 'flex';
      renderReadMode();
    } else {
      searchBar.style.display = 'none';
    }
  }

  function formatInlineText(text) {
    // Escape HTML
    text = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    // URLs
    text = text.replace(/(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank" rel="noopener">$1</a>');
    // Inline code
    text = text.replace(/`([^`]+)`/g, '<span class="inline-code">$1</span>');
    // Bold
    text = text.replace(/\*\*(.+?)\*\*/g, '<span class="bold">$1</span>');
    // Italic
    text = text.replace(/\*(.+?)\*/g, '<span class="italic">$1</span>');
    // Strikethrough
    text = text.replace(/~~(.+?)~~/g, '<span class="strikethrough">$1</span>');
    // Tags
    text = text.replace(/#(\w[\w-]*)/g, '<span class="tag" onclick="filterByTag(\'$1\')">#$1</span>');
    return text;
  }

  function renderReadMode() {
    const text = editor.value;
    const lines = text.split('\n');
    let html = '';

    const sq = searchInput.value || '';
    const query = sq.toLowerCase();

    // Show/hide clear button
    clearBtn.style.display = (sq || activeTagFilter) ? '' : 'none';

    // Active tag filter
    if (activeTagFilter) {
      activeFilterEl.innerHTML = `<div class="active-filter">Filtering: #${activeTagFilter} <span class="remove-filter" onclick="clearTagFilter()">x</span></div>`;
    } else {
      activeFilterEl.innerHTML = '';
    }

    for (let i = 0; i < lines.length; i++) {
      const line = lines[i];

      // Date header: === Day, Month Date, Year ===
      const dateMatch = line.match(/^===\s*(.+?)\s*===$/);
      if (dateMatch) {
        html += `<div class="date-header">${dateMatch[1]}</div>`;
        continue;
      }

      // Timestamped entry: [HH:MM:SS] or [HH:MM:SS @MACHINE]
      const entryMatch = line.match(/^\[(\d{1,2}:\d{2}:\d{2})(?:\s+@(\w+))?\]\s*(.*)/);
      if (entryMatch) {
        const time = entryMatch[1];
        const machine = entryMatch[2] || '';
        const body = entryMatch[3];

        // Tag filter
        if (activeTagFilter) {
          const re = new RegExp('#' + activeTagFilter + '\\b', 'i');
          if (!re.test(body)) continue;
        }
        // Search filter
        if (query && !body.toLowerCase().includes(query) && !time.includes(query)) continue;

        let machineHtml = machine ? ` <span class="entry-machine">@${machine}</span>` : '';
        html += '<div class="entry">';
        html += `<span class="entry-time">${time}${machineHtml}</span>`;
        html += `<span class="entry-body">${formatInlineText(body)}</span>`;
        html += '</div>';
        continue;
      }

      // Horizontal rule
      if (/^-{3,}\s*$/.test(line)) {
        html += '<hr>';
        continue;
      }

      // Headings
      const headingMatch = line.match(/^(#{1,3})\s+(.+)/);
      if (headingMatch) {
        const level = headingMatch[1].length;
        const content = headingMatch[2];
        if (query && !content.toLowerCase().includes(query)) continue;
        html += `<div class="heading h${level}">${formatInlineText(content)}</div>`;
        continue;
      }

      // Blockquote
      if (line.startsWith('> ')) {
        const content = line.substring(2);
        if (query && !content.toLowerCase().includes(query)) continue;
        html += `<blockquote>${formatInlineText(content)}</blockquote>`;
        continue;
      }

      // List item
      if (/^[-*]\s+/.test(line)) {
        const content = line.replace(/^[-*]\s+/, '');
        if (query && !content.toLowerCase().includes(query)) continue;
        html += `<div class="list-item">${formatInlineText(content)}</div>`;
        continue;
      }

      // Empty line
      if (line.trim() === '') {
        html += '<div class="plain-line"></div>';
        continue;
      }

      // Plain text line
      if (query && !line.toLowerCase().includes(query)) continue;
      html += `<div class="plain-line">${formatInlineText(line)}</div>`;
    }

    readerContent.innerHTML = html;
  }

  function filterByTag(tag) {
    activeTagFilter = tag;
    renderReadMode();
  }

  function clearTagFilter() {
    activeTagFilter = '';
    renderReadMode();
  }

  function clearFilters() {
    activeTagFilter = '';
    searchInput.value = '';
    renderReadMode();
  }

  // --- File operations ---
  function updateTitle(name) {
    filenameEl.textContent = name || 'untitled';
    document.title = (name || 'untitled') + ' - Notepad';
  }

  // --- Timer ---
  const timerEl = document.getElementById('timer');
  let timerInterval = null;
  let timerSeconds = 0;
  let timerRunning = false;

  function formatTimer(s) {
    const m = Math.floor(s / 60);
    const sec = s % 60;
    return m + ':' + String(sec).padStart(2, '0');
  }

  function toggleTimer() {
    if (timerRunning) {
      clearInterval(timerInterval);
      timerRunning = false;
      timerEl.classList.remove('running');
    } else {
      timerRunning = true;
      timerEl.classList.add('running');
      timerInterval = setInterval(() => {
        timerSeconds++;
        timerEl.textContent = formatTimer(timerSeconds);
      }, 1000);
    }
  }

  timerEl.addEventListener('dblclick', (e) => {
    e.preventDefault();
    clearInterval(timerInterval);
    timerRunning = false;
    timerSeconds = 0;
    timerEl.textContent = '0:00';
    timerEl.classList.remove('running');
  });

  function updateWordCount() {
    const text = editor.value.trim();
    const words = text ? text.split(/\s+/).length : 0;
    wordcountEl.textContent = words === 1 ? '1 word' : words + ' words';
  }

  function markDirty() {
    modifiedEl.textContent = editor.value !== savedContent ? '(modified)' : '';
    updateWordCount();
  }

  editor.addEventListener('input', markDirty);

  function newFile() {
    if (editor.value !== savedContent && !confirm('Discard unsaved changes?')) return;
    fileHandle = null;
    editor.value = '';
    savedContent = '';
    updateTitle('untitled');
    markDirty();
    if (inReadMode) renderReadMode();
  }

  async function openFile() {
    if (editor.value !== savedContent && !confirm('Discard unsaved changes?')) return;
    try {
      [fileHandle] = await window.showOpenFilePicker({
        types: [{ description: 'Text Files', accept: { 'text/plain': ['.txt', '.md', '.log', '.csv', '.json', '.xml', '.html', '.css', '.js', '.ps1', '.py'] }}],
        multiple: false
      });
      const file = await fileHandle.getFile();
      editor.value = await file.text();
      savedContent = editor.value;
      updateTitle(fileHandle.name);
      markDirty();
      if (inReadMode) renderReadMode();
    } catch (e) {
      if (e.name !== 'AbortError') console.error(e);
    }
  }

  async function saveFile() {
    if (!fileHandle) return saveFileAs();
    try {
      const writable = await fileHandle.createWritable();
      await writable.write(editor.value);
      await writable.close();
      savedContent = editor.value;
      markDirty();
    } catch (e) {
      if (e.name !== 'AbortError') console.error(e);
    }
  }

  async function saveFileAs() {
    try {
      fileHandle = await window.showSaveFilePicker({
        suggestedName: fileHandle ? fileHandle.name : 'untitled.txt',
        types: [{ description: 'Text Files', accept: { 'text/plain': ['.txt'] }}]
      });
      await saveFile();
      updateTitle(fileHandle.name);
    } catch (e) {
      if (e.name !== 'AbortError') console.error(e);
    }
  }

  // --- Copy to clipboard ---
  async function copyToClipboard() {
    try {
      await navigator.clipboard.writeText(editor.value);
      const btn = event.target;
      btn.textContent = 'Copied!';
      setTimeout(() => btn.textContent = 'Copy', 1500);
    } catch (e) {
      console.error(e);
    }
  }

  // --- Email draft (Gmail compose) ---
  function emailDraft() {
    const subject = encodeURIComponent(filenameEl.textContent || 'Notepad');
    const body = encodeURIComponent(editor.value);
    window.open('https://mail.google.com/mail/?view=cm&su=' + subject + '&body=' + body, '_blank');
  }

  // --- Word export ---
  function formatContentForWord(text) {
    const lines = text.split('\n');
    let html = '';

    for (let i = 0; i < lines.length; i++) {
      const line = lines[i];

      // Date header: === ... ===
      const dateMatch = line.match(/^===\s*(.+?)\s*===$/);
      if (dateMatch) {
        html += `<h2 style="border-bottom:1px solid #ccc;padding-bottom:4px;color:#444;">${dateMatch[1]}</h2>`;
        continue;
      }

      // Timestamped entry: [HH:MM:SS] or [HH:MM:SS @MACHINE]
      const entryMatch = line.match(/^\[(\d{1,2}:\d{2}:\d{2})(?:\s+@(\w+))?\]\s*(.*)/);
      if (entryMatch) {
        const time = entryMatch[1];
        const machine = entryMatch[2] ? ` <span style="font-size:9pt;background:#e8e8e8;color:#666;padding:1px 5px;border-radius:3px;">@${entryMatch[2]}</span>` : '';
        const body = formatInlineWord(entryMatch[3]);
        html += `<p style="margin:4px 0;"><span style="font-size:9pt;color:#888;font-family:Courier New;min-width:60px;display:inline-block;">${time}</span>${machine}&nbsp;&nbsp;${body}</p>`;
        continue;
      }

      // Horizontal rule
      if (/^-{3,}\s*$/.test(line)) {
        html += '<hr style="border:none;border-top:1px solid #ddd;margin:8px 0;">';
        continue;
      }

      // Headings
      const headingMatch = line.match(/^(#{1,3})\s+(.+)/);
      if (headingMatch) {
        const level = headingMatch[1].length;
        html += `<h${level}>${formatInlineWord(headingMatch[2])}</h${level}>`;
        continue;
      }

      // Blockquote
      if (line.startsWith('> ')) {
        html += `<blockquote style="border-left:3px solid #ccc;margin:4px 0;padding:2px 12px;color:#555;font-style:italic;">${formatInlineWord(line.substring(2))}</blockquote>`;
        continue;
      }

      // List item
      if (/^[-*]\s+/.test(line)) {
        html += `<li style="margin:2px 0;">${formatInlineWord(line.replace(/^[-*]\s+/, ''))}</li>`;
        continue;
      }

      // Empty line
      if (line.trim() === '') {
        html += '<p style="margin:4px 0;">&nbsp;</p>';
        continue;
      }

      // Plain line
      html += `<p style="margin:4px 0;">${formatInlineWord(line)}</p>`;
    }

    return html;
  }

  function formatInlineWord(text) {
    text = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    text = text.replace(/(https?:\/\/[^\s<]+)/g, '<a href="$1">$1</a>');
    text = text.replace(/`([^`]+)`/g, '<code style="font-family:Courier New;background:#f0f0f0;padding:1px 4px;">$1</code>');
    text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
    text = text.replace(/\*(.+?)\*/g, '<em>$1</em>');
    text = text.replace(/~~(.+?)~~/g, '<s>$1</s>');
    text = text.replace(/#(\w[\w-]*)/g, '<span style="color:#336;background:#e3f0ff;padding:1px 6px;border-radius:8px;">#$1</span>');
    return text;
  }

  function exportToWord() {
    const showBrand = localStorage.getItem('notepad-showBrand') === 'true';
    const logo = localStorage.getItem('notepad-logo') || '';
    const brandName = localStorage.getItem('notepad-brandText') || '';
    const fontFamily = localStorage.getItem('notepad-fontFamily') || 'Calibri, sans-serif';
    const fontSize = localStorage.getItem('notepad-fontSize') || '11';

    let headerHtml = '';
    if (showBrand && (logo || brandName)) {
      headerHtml = '<div style="display:flex;align-items:center;gap:12px;border-bottom:2px solid #ccc;padding-bottom:12px;margin-bottom:20px;">';
      if (logo) headerHtml += `<img src="${logo}" style="max-height:60px;max-width:200px;">`;
      if (brandName) headerHtml += `<span style="font-size:16pt;font-weight:600;">${brandName}</span>`;
      headerHtml += '</div>';
    }

    const content = formatContentForWord(editor.value);
    const docName = filenameEl.textContent !== 'untitled' ? filenameEl.textContent.replace(/\.[^.]+$/, '') : 'document';

    const html = `
<html xmlns:o="urn:schemas-microsoft-com:office:office"
      xmlns:w="urn:schemas-microsoft-com:office:word"
      xmlns="http://www.w3.org/TR/REC-html40">
<head>
<meta charset="UTF-8">
<style>
  body { font-family: ${fontFamily}; font-size: ${fontSize}pt; margin: 1in; line-height: 1.4; }
  h1 { font-size: 18pt; } h2 { font-size: 14pt; } h3 { font-size: 12pt; }
  p { margin: 4px 0; }
</style>
</head>
<body>
${headerHtml}
${content}
</body>
</html>`;

    const blob = new Blob(['\ufeff', html], { type: 'application/msword' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = docName + '.doc';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  // --- Keyboard shortcuts ---
  document.addEventListener('keydown', (e) => {
    if (e.ctrlKey && e.key === 's') { e.preventDefault(); saveFile(); }
    if (e.ctrlKey && e.key === 'o') { e.preventDefault(); openFile(); }
    if (e.ctrlKey && e.key === 'n') { e.preventDefault(); newFile(); }
    if (e.ctrlKey && e.key === 'r' && !e.shiftKey) { e.preventDefault(); toggleReadMode(); }
  });

  editor.addEventListener('keydown', (e) => {
    if (e.key === 'Tab') {
      e.preventDefault();
      const start = editor.selectionStart;
      const end = editor.selectionEnd;
      editor.value = editor.value.substring(0, start) + '\t' + editor.value.substring(end);
      editor.selectionStart = editor.selectionEnd = start + 1;
      markDirty();
    }
  });

  updateTitle('untitled');
</script>
</body>
</html>
