<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect x='15' y='8' width='50' height='65' rx='3' fill='%23f5f5dc' stroke='%23555' stroke-width='3'/><line x1='25' y1='25' x2='55' y2='25' stroke='%23aaa' stroke-width='2'/><line x1='25' y1='35' x2='55' y2='35' stroke='%23aaa' stroke-width='2'/><line x1='25' y1='45' x2='45' y2='45' stroke='%23aaa' stroke-width='2'/><rect x='58' y='50' width='8' height='38' rx='2' transform='rotate(-30 62 69)' fill='%23f4c430' stroke='%23555' stroke-width='2'/><polygon points='49,84 53,74 57,78' fill='%23555'/></svg>">
<title>Notepad</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { display: flex; flex-direction: column; height: 100vh; font-family: system-ui; }
  #toolbar {
    display: flex; gap: 4px; padding: 6px 8px;
    background: #f0f0f0; border-bottom: 1px solid #ccc;
    align-items: center; flex-wrap: wrap;
  }
  #toolbar button {
    padding: 4px 12px; border: 1px solid #aaa; background: #fff;
    border-radius: 3px; cursor: pointer; font-size: 13px; color: #000;
  }
  #toolbar button:hover { background: #e8e8e8; }
  #toolbar button.active { background: #ddeeff; border-color: #88b; }
  .separator { width: 1px; height: 20px; background: #ccc; margin: 0 4px; }
  #filename { margin-left: 12px; color: #555; font-size: 13px; }
  #modified { color: #c00; font-size: 13px; margin-left: 4px; }
  #brand-bar {
    display: none; padding: 12px 16px; align-items: center; gap: 12px;
    border-bottom: 1px solid #ccc; background: #fafafa;
  }
  #brand-bar.visible { display: flex; }
  #brand-logo {
    max-height: 48px; max-width: 200px; object-fit: contain; cursor: pointer;
  }
  #brand-logo:hover { opacity: 0.8; }
  #brand-placeholder {
    width: 48px; height: 48px; border: 2px dashed #aaa; border-radius: 6px;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; color: #999; font-size: 11px; text-align: center;
  }
  #brand-placeholder:hover { border-color: #666; color: #666; }
  #brand-text {
    font-size: 16px; font-weight: 600; color: #333;
    border: none; background: transparent; outline: none;
    font-family: system-ui; min-width: 120px;
  }
  #brand-text::placeholder { color: #aaa; }
  #content-area { display: flex; flex-direction: column; flex: 1; min-height: 0; position: relative; }
  #editor {
    flex: 1; padding: 12px; font-family: Consolas, 'Courier New', monospace;
    font-size: 14px; border: none; outline: none; resize: none;
    white-space: pre; overflow: auto; tab-size: 4;
    background: #fff; color: #000;
  }

  /* Read mode */
  #reader {
    display: none; flex: 1; padding: 20px 32px; overflow: auto;
    font-family: system-ui; font-size: 15px; line-height: 1.6;
    background: #fff; color: #222;
  }
  #reader.visible { display: block; }
  #reader .date-header {
    font-size: 18px; font-weight: 700; color: #444;
    border-bottom: 2px solid #e0e0e0; padding: 16px 0 6px;
    margin: 24px 0 12px;
  }
  #reader .date-header:first-child { margin-top: 0; }
  #reader .entry {
    display: flex; gap: 12px; padding: 8px 0;
    border-bottom: 1px solid #f0f0f0;
  }
  #reader .entry-time {
    font-size: 12px; color: #888; font-family: Consolas, 'Courier New', monospace;
    white-space: nowrap; min-width: 70px; padding-top: 2px;
  }
  #reader .entry-machine {
    font-size: 10px; background: #e8e8e8; color: #666;
    padding: 1px 6px; border-radius: 3px; font-family: Consolas, monospace;
    vertical-align: middle;
  }
  #reader .entry-body { flex: 1; word-wrap: break-word; }
  #reader .entry-body a { color: #2266cc; }
  #reader .tag {
    display: inline-block; font-size: 12px; padding: 1px 8px;
    border-radius: 10px; margin: 0 2px; cursor: pointer;
    background: #e3f0ff; color: #336; font-weight: 500;
  }
  #reader .tag:hover { background: #c8e0ff; }
  #reader .plain-line { padding: 4px 0; }
  #reader .plain-line:empty { height: 8px; }
  #reader .bold { font-weight: 700; }
  #reader .italic { font-style: italic; }
  #reader .inline-code {
    font-family: Consolas, 'Courier New', monospace; font-size: 13px;
    background: #f0f0f0; padding: 1px 5px; border-radius: 3px;
  }
  #reader blockquote {
    border-left: 3px solid #ccc; padding: 4px 12px; margin: 4px 0;
    color: #555; font-style: italic;
  }
  #reader .search-bar {
    display: flex; gap: 8px; padding: 8px 0 16px; align-items: center;
  }
  #reader .search-bar input {
    flex: 1; padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px;
    font-size: 14px; font-family: system-ui; outline: none;
  }
  #reader .search-bar input:focus { border-color: #88b; }
  #reader .search-bar .clear-btn {
    padding: 6px 12px; border: 1px solid #aaa; background: #f5f5f5;
    border-radius: 4px; cursor: pointer; font-size: 13px;
  }
  #reader .active-filter {
    display: inline-flex; align-items: center; gap: 4px;
    font-size: 13px; background: #e3f0ff; color: #336;
    padding: 4px 10px; border-radius: 12px; margin-bottom: 12px;
  }
  #reader .active-filter .remove-filter {
    cursor: pointer; font-weight: bold; margin-left: 4px;
    color: #666;
  }
  #reader .active-filter .remove-filter:hover { color: #c00; }

  .color-input-wrap { position: relative; display: inline-block; }
  .color-input-wrap input[type="color"] {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    opacity: 0; cursor: pointer;
  }

  /* Settings panel */
  #settings-panel {
    display: none; position: absolute; top: 36px; right: 8px;
    background: #fff; border: 1px solid #ccc; border-radius: 6px;
    padding: 12px 16px; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    min-width: 220px;
  }
  #settings-panel.visible { display: block; }
  #settings-panel label {
    display: flex; align-items: center; gap: 8px;
    font-size: 13px; color: #333; margin-bottom: 8px; cursor: pointer;
  }
  #settings-panel .setting-row {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 8px;
  }
  #settings-panel .setting-label { font-size: 13px; color: #333; }
  #settings-panel input[type="color"] { width: 32px; height: 24px; border: 1px solid #aaa; border-radius: 3px; cursor: pointer; }
  #settings-panel input[type="range"] { width: 100px; cursor: pointer; }
  #settings-panel .font-size-val { font-size: 13px; min-width: 32px; text-align: center; }
  #settings-panel button {
    padding: 3px 10px; border: 1px solid #aaa; background: #f5f5f5;
    border-radius: 3px; cursor: pointer; font-size: 12px; color: #333;
  }
  #settings-panel button:hover { background: #e0e0e0; }

  /* Dark mode */
  body.dark { background: #1e1e1e; }
  body.dark #toolbar { background: #2d2d2d; border-bottom-color: #444; }
  body.dark #toolbar button { background: #3c3c3c; border-color: #555; color: #ddd; }
  body.dark #toolbar button:hover { background: #505050; }
  body.dark #toolbar button.active { background: #2a3a4a; border-color: #5588aa; }
  body.dark .separator { background: #555; }
  body.dark #filename { color: #aaa; }
  body.dark #modified { color: #f66; }
  body.dark #brand-bar { background: #252525; border-bottom-color: #444; }
  body.dark #brand-text { color: #ddd; }
  body.dark #brand-text::placeholder { color: #666; }
  body.dark #brand-placeholder { border-color: #555; color: #777; }
  body.dark #editor { background: #1e1e1e; color: #d4d4d4; }
  body.dark #reader { background: #1e1e1e; color: #d4d4d4; }
  body.dark #reader .date-header { color: #ccc; border-bottom-color: #444; }
  body.dark #reader .entry { border-bottom-color: #333; }
  body.dark #reader .entry-time { color: #777; }
  body.dark #reader .entry-machine { background: #3c3c3c; color: #aaa; }
  body.dark #reader .tag { background: #2a3a4a; color: #8cb4e0; }
  body.dark #reader .tag:hover { background: #344a5a; }
  body.dark #reader .entry-body a { color: #6cacee; }
  body.dark #reader .inline-code { background: #333; color: #d4d4d4; }
  body.dark #reader blockquote { border-left-color: #555; color: #999; }
  body.dark #reader .search-bar input { background: #2d2d2d; border-color: #555; color: #ddd; }
  body.dark #reader .search-bar .clear-btn { background: #3c3c3c; border-color: #555; color: #ddd; }
  body.dark #reader .active-filter { background: #2a3a4a; color: #8cb4e0; }
  body.dark #settings-panel { background: #2d2d2d; border-color: #444; color: #ddd; }
  body.dark #settings-panel .setting-label { color: #ddd; }
  body.dark #settings-panel label { color: #ddd; }
  body.dark #settings-panel button { background: #3c3c3c; border-color: #555; color: #ddd; }
  body.dark #settings-panel button:hover { background: #505050; }

  @media print {
    #toolbar, #settings-panel { display: none !important; }
    #brand-bar.visible { display: flex !important; }
    #editor, #reader { overflow: visible; }
    #reader .search-bar { display: none !important; }
    #reader .active-filter { display: none !important; }
  }
</style>
</head>
<body class="dark">
<div id="toolbar">
  <button onclick="newFile()">New</button>
  <button onclick="openFile()">Open</button>
  <button onclick="saveFile()">Save</button>
  <button onclick="saveFileAs()">Save As</button>
  <div class="separator"></div>
  <button onclick="toggleReadMode()" id="readBtn">Read</button>
  <div class="separator"></div>
  <button onclick="toggleTheme()" id="themeBtn">Light</button>
  <button onclick="toggleSettings()">Settings</button>
  <span id="filename">untitled</span>
  <span id="modified"></span>
</div>
<div id="settings-panel">
  <label>
    <input type="checkbox" id="showBrand" onchange="toggleBrand()">
    Show letterhead
  </label>
  <div class="setting-row">
    <span class="setting-label">Logo</span>
    <span>
      <button onclick="pickLogo()">Choose</button>
      <button onclick="removeLogo()">Remove</button>
    </span>
  </div>
  <div class="setting-row">
    <span class="setting-label">Font size</span>
    <span style="display:flex;align-items:center;gap:4px">
      <input type="range" id="fontSize" min="10" max="32" value="14" oninput="setFontSize(this.value)">
      <span class="font-size-val" id="fontSizeVal">14px</span>
    </span>
  </div>
  <div class="setting-row">
    <span class="setting-label">Editor background</span>
    <input type="color" id="bgColor" value="#1e1e1e" onchange="setBgColor(this.value)">
  </div>
  <div class="setting-row">
    <span class="setting-label">Text color</span>
    <input type="color" id="fgColor" value="#d4d4d4" onchange="setFgColor(this.value)">
  </div>
  <div class="setting-row">
    <span class="setting-label">Background image</span>
    <span>
      <button onclick="pickBgImage()">Choose</button>
      <button onclick="removeBgImage()">Remove</button>
    </span>
  </div>
  <div class="setting-row">
    <button onclick="resetSettings()">Reset all settings</button>
  </div>
</div>
<div id="brand-bar">
  <div id="brand-placeholder" onclick="pickLogo()">Add<br>logo</div>
  <img id="brand-logo" style="display:none" onclick="pickLogo()">
  <input type="text" id="brand-text" placeholder="Your name or company">
</div>
<div id="content-area">
  <textarea id="editor" spellcheck="false"></textarea>
  <div id="reader"></div>
</div>
<input type="file" id="logoInput" accept="image/*" style="display:none">
<input type="file" id="bgInput" accept="image/*" style="display:none">
<script>
  let fileHandle = null;
  let savedContent = '';
  let inReadMode = false;
  let activeTagFilter = '';
  const editor = document.getElementById('editor');
  const reader = document.getElementById('reader');
  const filenameEl = document.getElementById('filename');
  const modifiedEl = document.getElementById('modified');
  const themeBtn = document.getElementById('themeBtn');
  const readBtn = document.getElementById('readBtn');
  const settingsPanel = document.getElementById('settings-panel');
  const brandBar = document.getElementById('brand-bar');
  const brandLogo = document.getElementById('brand-logo');
  const brandPlaceholder = document.getElementById('brand-placeholder');
  const brandText = document.getElementById('brand-text');
  const showBrandCheck = document.getElementById('showBrand');
  const bgColorInput = document.getElementById('bgColor');
  const fgColorInput = document.getElementById('fgColor');
  const logoInput = document.getElementById('logoInput');
  const bgInput = document.getElementById('bgInput');
  const fontSizeInput = document.getElementById('fontSize');
  const fontSizeVal = document.getElementById('fontSizeVal');

  // --- Theme ---
  function toggleTheme() {
    const dark = document.body.classList.toggle('dark');
    themeBtn.textContent = dark ? 'Light' : 'Dark';
    localStorage.setItem('notepad-theme', dark ? 'dark' : 'light');
  }

  // --- Settings panel ---
  function toggleSettings() {
    settingsPanel.classList.toggle('visible');
  }
  document.addEventListener('click', (e) => {
    if (!settingsPanel.contains(e.target) && e.target.textContent !== 'Settings') {
      settingsPanel.classList.remove('visible');
    }
  });

  // --- Brand / Letterhead ---
  function toggleBrand() {
    const show = showBrandCheck.checked;
    brandBar.classList.toggle('visible', show);
    localStorage.setItem('notepad-showBrand', show);
  }

  // --- Logo ---
  function pickLogo() { logoInput.click(); }
  logoInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      setLogo(reader.result);
      localStorage.setItem('notepad-logo', reader.result);
    };
    reader.readAsDataURL(file);
    logoInput.value = '';
  });
  function setLogo(dataUrl) {
    brandLogo.src = dataUrl;
    brandLogo.style.display = 'block';
    brandPlaceholder.style.display = 'none';
  }
  function removeLogo() {
    brandLogo.src = '';
    brandLogo.style.display = 'none';
    brandPlaceholder.style.display = 'flex';
    localStorage.removeItem('notepad-logo');
  }

  // --- Brand text ---
  brandText.addEventListener('input', () => {
    localStorage.setItem('notepad-brandText', brandText.value);
  });

  // --- Font size ---
  function setFontSize(size) {
    editor.style.fontSize = size + 'px';
    reader.style.fontSize = size + 'px';
    fontSizeInput.value = size;
    fontSizeVal.textContent = size + 'px';
    localStorage.setItem('notepad-fontSize', size);
  }

  // --- Editor colors ---
  function setBgColor(color) {
    editor.style.background = color;
    localStorage.setItem('notepad-bgColor', color);
  }
  function setFgColor(color) {
    editor.style.color = color;
    localStorage.setItem('notepad-fgColor', color);
  }

  // --- Background image ---
  function pickBgImage() { bgInput.click(); }
  bgInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const r = new FileReader();
    r.onload = () => {
      setBgImage(r.result);
      localStorage.setItem('notepad-bgImage', r.result);
    };
    r.readAsDataURL(file);
    bgInput.value = '';
  });
  function setBgImage(dataUrl) {
    editor.style.backgroundImage = `url(${dataUrl})`;
    editor.style.backgroundSize = 'cover';
    editor.style.backgroundPosition = 'center';
    editor.style.backgroundRepeat = 'no-repeat';
  }
  function removeBgImage() {
    editor.style.backgroundImage = '';
    localStorage.removeItem('notepad-bgImage');
  }

  // --- Reset ---
  function resetSettings() {
    if (!confirm('Reset all settings to defaults?')) return;
    ['notepad-theme','notepad-showBrand','notepad-logo','notepad-brandText',
     'notepad-fontSize','notepad-bgColor','notepad-fgColor','notepad-bgImage'].forEach(k => localStorage.removeItem(k));
    location.reload();
  }

  // --- Restore settings ---
  function restoreSettings() {
    if (localStorage.getItem('notepad-theme') === 'light') {
      document.body.classList.remove('dark');
      themeBtn.textContent = 'Dark';
    }
    if (localStorage.getItem('notepad-showBrand') === 'true') {
      showBrandCheck.checked = true;
      brandBar.classList.add('visible');
    }
    const logo = localStorage.getItem('notepad-logo');
    if (logo) setLogo(logo);
    const bt = localStorage.getItem('notepad-brandText');
    if (bt) brandText.value = bt;
    const fs = localStorage.getItem('notepad-fontSize');
    if (fs) setFontSize(fs);
    const bg = localStorage.getItem('notepad-bgColor');
    if (bg) { editor.style.background = bg; bgColorInput.value = bg; }
    const fg = localStorage.getItem('notepad-fgColor');
    if (fg) { editor.style.color = fg; fgColorInput.value = fg; }
    const bgImg = localStorage.getItem('notepad-bgImage');
    if (bgImg) setBgImage(bgImg);
  }
  restoreSettings();

  // --- Read mode ---
  function toggleReadMode() {
    inReadMode = !inReadMode;
    editor.style.display = inReadMode ? 'none' : '';
    reader.classList.toggle('visible', inReadMode);
    readBtn.textContent = inReadMode ? 'Edit' : 'Read';
    readBtn.classList.toggle('active', inReadMode);
    if (inReadMode) renderReadMode();
  }

  function formatInlineText(text) {
    // Escape HTML
    text = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    // URLs
    text = text.replace(/(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank" rel="noopener">$1</a>');
    // Inline code
    text = text.replace(/`([^`]+)`/g, '<span class="inline-code">$1</span>');
    // Bold
    text = text.replace(/\*\*(.+?)\*\*/g, '<span class="bold">$1</span>');
    // Italic
    text = text.replace(/\*(.+?)\*/g, '<span class="italic">$1</span>');
    // Tags
    text = text.replace(/#(\w[\w-]*)/g, '<span class="tag" onclick="filterByTag(\'$1\')">#$1</span>');
    return text;
  }

  function renderReadMode(searchQuery) {
    const text = editor.value;
    const lines = text.split('\n');
    let html = '';

    // Search bar
    const sq = searchQuery || '';
    html += '<div class="search-bar">';
    html += `<input type="text" placeholder="Search..." value="${sq.replace(/"/g, '&quot;')}" oninput="renderReadMode(this.value)">`;
    if (sq || activeTagFilter) html += '<button class="clear-btn" onclick="clearFilters()">Clear</button>';
    html += '</div>';

    if (activeTagFilter) {
      html += `<div class="active-filter">Filtering: #${activeTagFilter} <span class="remove-filter" onclick="clearTagFilter()">x</span></div>`;
    }

    const query = sq.toLowerCase();

    for (let i = 0; i < lines.length; i++) {
      const line = lines[i];

      // Date header: === Day, Month Date, Year ===
      const dateMatch = line.match(/^===\s*(.+?)\s*===$/);
      if (dateMatch) {
        html += `<div class="date-header">${dateMatch[1]}</div>`;
        continue;
      }

      // Timestamped entry: [HH:MM:SS] or [HH:MM:SS @MACHINE]
      const entryMatch = line.match(/^\[(\d{1,2}:\d{2}:\d{2})(?:\s+@(\w+))?\]\s*(.*)/);
      if (entryMatch) {
        const time = entryMatch[1];
        const machine = entryMatch[2] || '';
        const body = entryMatch[3];

        // Tag filter
        if (activeTagFilter) {
          const re = new RegExp('#' + activeTagFilter + '\\b', 'i');
          if (!re.test(body)) continue;
        }
        // Search filter
        if (query && !body.toLowerCase().includes(query) && !time.includes(query)) continue;

        let machineHtml = machine ? ` <span class="entry-machine">@${machine}</span>` : '';
        html += '<div class="entry">';
        html += `<span class="entry-time">${time}${machineHtml}</span>`;
        html += `<span class="entry-body">${formatInlineText(body)}</span>`;
        html += '</div>';
        continue;
      }

      // Blockquote
      if (line.startsWith('> ')) {
        const content = line.substring(2);
        if (query && !content.toLowerCase().includes(query)) continue;
        html += `<blockquote>${formatInlineText(content)}</blockquote>`;
        continue;
      }

      // Empty line
      if (line.trim() === '') {
        html += '<div class="plain-line"></div>';
        continue;
      }

      // Plain text line
      if (query && !line.toLowerCase().includes(query)) continue;
      html += `<div class="plain-line">${formatInlineText(line)}</div>`;
    }

    reader.innerHTML = html;
  }

  function filterByTag(tag) {
    activeTagFilter = tag;
    renderReadMode(reader.querySelector('.search-bar input')?.value || '');
  }

  function clearTagFilter() {
    activeTagFilter = '';
    renderReadMode(reader.querySelector('.search-bar input')?.value || '');
  }

  function clearFilters() {
    activeTagFilter = '';
    renderReadMode('');
  }

  // --- File operations ---
  function updateTitle(name) {
    filenameEl.textContent = name || 'untitled';
    document.title = (name || 'untitled') + ' - Notepad';
  }

  function markDirty() {
    modifiedEl.textContent = editor.value !== savedContent ? '(modified)' : '';
  }

  editor.addEventListener('input', markDirty);

  function newFile() {
    if (editor.value !== savedContent && !confirm('Discard unsaved changes?')) return;
    fileHandle = null;
    editor.value = '';
    savedContent = '';
    updateTitle('untitled');
    markDirty();
    if (inReadMode) renderReadMode();
  }

  async function openFile() {
    if (editor.value !== savedContent && !confirm('Discard unsaved changes?')) return;
    try {
      [fileHandle] = await window.showOpenFilePicker({
        types: [{ description: 'Text Files', accept: { 'text/plain': ['.txt', '.md', '.log', '.csv', '.json', '.xml', '.html', '.css', '.js', '.ps1', '.py'] }}],
        multiple: false
      });
      const file = await fileHandle.getFile();
      editor.value = await file.text();
      savedContent = editor.value;
      updateTitle(fileHandle.name);
      markDirty();
      if (inReadMode) renderReadMode();
    } catch (e) {
      if (e.name !== 'AbortError') console.error(e);
    }
  }

  async function saveFile() {
    if (!fileHandle) return saveFileAs();
    try {
      const writable = await fileHandle.createWritable();
      await writable.write(editor.value);
      await writable.close();
      savedContent = editor.value;
      markDirty();
    } catch (e) {
      if (e.name !== 'AbortError') console.error(e);
    }
  }

  async function saveFileAs() {
    try {
      fileHandle = await window.showSaveFilePicker({
        suggestedName: fileHandle ? fileHandle.name : 'untitled.txt',
        types: [{ description: 'Text Files', accept: { 'text/plain': ['.txt'] }}]
      });
      await saveFile();
      updateTitle(fileHandle.name);
    } catch (e) {
      if (e.name !== 'AbortError') console.error(e);
    }
  }

  // --- Keyboard shortcuts ---
  document.addEventListener('keydown', (e) => {
    if (e.ctrlKey && e.key === 's') { e.preventDefault(); saveFile(); }
    if (e.ctrlKey && e.key === 'o') { e.preventDefault(); openFile(); }
    if (e.ctrlKey && e.key === 'n') { e.preventDefault(); newFile(); }
    if (e.ctrlKey && e.key === 'r' && !e.shiftKey) { e.preventDefault(); toggleReadMode(); }
  });

  editor.addEventListener('keydown', (e) => {
    if (e.key === 'Tab') {
      e.preventDefault();
      const start = editor.selectionStart;
      const end = editor.selectionEnd;
      editor.value = editor.value.substring(0, start) + '\t' + editor.value.substring(end);
      editor.selectionStart = editor.selectionEnd = start + 1;
      markDirty();
    }
  });

  updateTitle('untitled');
</script>
</body>
</html>
